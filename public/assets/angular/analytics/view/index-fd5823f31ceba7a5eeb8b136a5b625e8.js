angular.module("aku.analytics.view.index",["d3","aku.analytics.model","aku.analytics.view.forms","aku.lib.text"]).directive("analyticsGraph",["$window","$timeout","d3Service",function(t,e,n){return{restrict:"A",scope:{courses:"=",data:"=",label:"@",onClick:"&",students:"="},link:function(a,r,i){n.d3().then(function(n){var o,u,l,s,c,d=(parseInt(i.barHeight)||20,n.scale.category20()),f=null,p=null;parseInt(i.padding)||5;var g=n.select(r[0]).append("svg").style("width","100%");t.onresize=function(){a.$apply()};var y=function(){return lineFunction=n.svg.line().x(function(t){return xScale(t.date)}).y(function(t){return yScale(t.data)}).interpolate("linear")},v=function(){var t=n.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").text("a simple tooltip");return t},h=function(){var t=n.svg.axis().scale(xScale).orient("bottom");return t},m=function(){var t=n.svg.axis().scale(yScale).orient("left");return t},k=function(){return xScale=n.time.scale().domain([p,f]).range([0+A(),getWidth()])},x=function(){return yScale=n.scale.ordinal().domain(["A","B","C","D","F"]).rangeRoundBands([0+A(),getHeight()-2*A()],1)},C=function(){g.append("g").attr("transform","translate(0,"+(getHeight()-2*A())+")").call(u)},S=function(){g.append("g").attr("transform","translate("+A()+", 0)").call(l)},b=function(t,e){for(var n=0;n<t.length;n++)if(t[n].name===e)return t[n];return null},w=function(t,e){for(var n=0;n<t.length;n++)if(t[n].student_id===e)return t[n];return null},A=function(){return parseInt(i.margin)||20};nodeFunctionCy=function(t){return yScale(t.data)},prepareDate=function(){s.forEach(function(t){t.date=new Date(t.datestring)})},prepareNest=function(){s=n.nest().key(function(t){return t.student_id}).key(function(t){return t.course_name}).entries(s)},getMinMaxDates=function(){s.forEach(function(t){null===p?p=t.date:t.date<p&&(p=t.date),null===f?f=t.date:t.date>f&&(f=t.date)})},drawLineGraphs=function(t){for(var e=a.students.allStudents,r=a.courses.allCourses,i=a.students.list,o=a.courses.list,u=0;u<s.length;u++){var l=s[u],f=w(i,l.key);if(f.checked===!0||e===!0)for(var p=0;p<s[u].values.length;p++){var y=s[u].values[p],v=b(o,y.key);if(null!==v&&v.checked===!0||r===!0){var h=g.append("path").attr("d",t(y.values));h.transition().attr("stroke",d(y.key)).attr("fill","none").attr("stroke-width",2);var m=g.selectAll("nonExistingTag").data(y.values).enter().append("circle");m.transition().attr("stroke",d(y.key+1)).attr("fill",d(y.key+1)).attr("cx",function(t){return xScale(t.date)}).attr("cy",function(t){return yScale(t.data)}).attr("r",5),m.on("mouseover",function(t){c.style("visibility","visible"),c.text(t.course_name+" | "+t.student_id+" | "+t.data)}).on("mousemove",function(){c.style("top",n.event.pageY-10+"px").style("left",n.event.pageX+10+"px")}).on("mouseout",function(){c.style("visibility","hidden")})}}}},getHeight=function(){return n.select(r[0])[0][0].offsetHeight-2*A()},getWidth=function(){return n.select(r[0])[0][0].offsetWidth-2*A()},a.$on("onApplyChanges",function(){a.render(a.data)}),a.$watch(function(){return angular.element(t)[0].innerWidth},function(){a.render(a.data)}),a.$watch("data",function(t){a.render(t)},!0),a.render=function(t){g.selectAll("*").remove(),t&&(o&&clearTimeout(o),o=e(function(){var e,n;s=t,prepareDate(),getMinMaxDates(),prepareNest(),c=v(),k(),x(),e=y(),drawLineGraphs(e),u=h(),C(n),l=m(),S(n)},200))}})}}}]).controller("mainController",["factoryAnalytics","$scope",function(t,e){e.onApplyChanges=function(){e.$broadcast("onApplyChanges")},e.onClickCourse=function(){e.courses.allCourses=!1},e.onClickStudent=function(){e.students.allStudents=!1},t.getCoreCourses(function(t){e.courses=t}),t.getData(function(t){e.data=t}),t.getStudents(function(t){e.students=t})}]);